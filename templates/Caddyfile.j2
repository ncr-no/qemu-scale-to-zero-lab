{
    admin off
    auto_https off
    order sablier before reverse_proxy
    log {
        output file /var/log/caddy/access.log {
            roll_size 10MB
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

:80 {
    log {
        output file /var/log/caddy/error.log {
            roll_size 10MB
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level ERROR
    }

    # Host container-lock at root
    handle_path / {
        reverse_proxy container-lock:8000 {
            header_up X-Real-IP {remote}
        }
    }

    # Redirect container paths to add trailing slash
    @containers path {% for i in range(1, n + 1) %}/vm/{{ container_prefix }}_{{ i }}{% if not loop.last %} {% endif %}{% endfor %}
    redir @containers {http.request.uri.path}/ permanent

    # VM routes moved to /vm/{{ container_prefix }}_* paths
    {% for i in range(1, n + 1) %}
    route /vm/{{ container_prefix }}_{{ i }}/* {
        uri strip_prefix /vm/{{ container_prefix }}_{{ i }}
        sablier http://sablier:10000 {
            names {{ container_prefix }}_{{ i }}
            session_duration 10m
            dynamic {
                display_name "{{ container_prefix | title }} Container {{ i }}"
                show_details true
                theme hacker-terminal
                refresh_frequency 5s
            }
        }
        reverse_proxy {{ container_prefix }}_{{ i }}:8006 {
            header_up Host {{ container_prefix }}_{{ i }}:8006
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    {% endfor %}

    # Redirect unmatched paths to container-lock
    @not_handled {
        {% for i in range(1, n + 1) %}
        not path /vm/{{ container_prefix }}_{{ i }}*
        {% endfor %}
    }
    handle @not_handled {
        reverse_proxy container-lock:8000 {
            header_up X-Real-IP {remote}
        }
    }
}